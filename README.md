tile_factory: Dirty map tiles, done dirt cheap.
============

Stuff to help move tiles from TileMill to S3 for use in slippy maps.

Heavily based on this (with some modifications): http://www.minnpost.com/data/2012/03/how-we-built-same-day-registration-map

###Creating the virtual environment
There's a little bit of a trick. Some packages are better installed globally, some in the environment.

```
mkvirtualenv --system-site-packages tile_factory
deactivate
pip install -r requirements_global.txt

workon tile_factory
pip install -r requirements_env.txt
deactivate

workon tile_factory

```
Annnnd you're done.

###The process
* Make tiles in TileMill.

* Export to MBTiles format. Remember: every extra zoom level you add increases the number of tiles by a factor of four.

* Extract tiles from the MBTiles file
  The MBTiles file is basically a database of tiles that you can upload to MapBox. Instead we want to make actual PNGs to upload to S3.
  
	* Add the name of the MBTiles file to the `MAPS_LIST` in your local_config.py file.
	* Specify an S3 bucket you want to place your tiles in.
	* Specify a version number. It's actually very slow to delete a tileset, so often if you want to do another version it's easier to just make a new version, which will be uploaded a new path in S3.
	* Run `fab deploy_all`. This will extract and upload the tile PNGs.

* Reference the tiles in your Leaflet (or other) JS mapping library. Some of this is generated by the script in the .json file, but you'll need to modify it a bit. In Leaflet, this will look like this:

```JS
my_tilejson = {
	    "autoscale": true,
	    "bounds": [
	        -129.6387,
	        27.4888,
	        -109.4238,
	        46.8902
	    ],
	    "center": [
	        -119.1138,
	        34.1437,
	        7
	    ],
	    "id": "pesticides-grids-1",
	    "maxzoom": 15,
	    "minzoom": 5,
	    "name": "Pesticide Grids (All chemicals)",
	    "private": false,
	    "scheme": "xyz",
	    "tilejson": "2.0.0",
	    "tiles": [
	        "http://static.apps.cironline.org/pesticides-tiles/PesticidesBasemapAllChemicals/0.8.1/{z}/{x}/{y}.png"
	    ],
	    "grids":[
	        "http://static.apps.cironline.org/pesticides-tiles/PesticidesBasemapAllChemicals/0.8.1/{z}/{x}/{y}.grid.json"
	    ],
	    "webpage": "",
	    "template": "{{#__location__}}{{/__location__}}{{#__teaser__}}Total lbs., fumigants: {{{total_lbs_used_fumigants_chemical}}}<br/>\nTotal lbs., all chemicals: {{{total_lbs_used_all_chemical}}}<br/><br/>\n\nTownship: {{{township}}}<br/>\nRange: {{{range}}}<br/>\nSection: {{{section}}}<br/>\nID: {{{id}}}{{/__teaser__}}{{#__full__}}{{/__full__}}"
	};
	
var map = L.mapbox.map('#mapcanvas');
var tilelayer = L.mapbox.tileLayer(my_tilejson, {crossOrigin:'null'});
var gridlayer = L.mapbox.gridLayer(my_tilejson);  // Only if you have accompanying utf grids.

var layergroup = L.layerGroup([tilelayer, gridlayer]);
layergroup.addTo(map);

```

###Deleting large tilesets

Deleting tens of thousands of tiles on S3 takes a long time. This command, based on @onyxfish's invar library, deletes everything in matching subfolders in chunks of 1,000 keys at a time, and in 64 concurrent threads at a time to speed things up even more.

WARNING: Use with extreme caution. This will wipe out every match it finds, no takebacks.

```
# local_config.py
DELETE_LIST = [] # Put map project folder names here
DELETE_BUCKET = 's3.bucket.name'
DELETE_BASE_DIRECTORY = 'everything/before/your/project/name'
DELETE_VERSION = '1.0.0'

# Use with extreme caution
$ fab delete_all
```
